<VirtualHost *:80>
	DocumentRoot /opt/bluespice

	SetEnv BASE_URL ###BASE_URL###

	<FilesMatch \.php$>
		SetHandler "proxy:fcgi://php-fpm:9000"
	</FilesMatch>

	RewriteEngine On

	#Spaces to underscores
	RewriteRule ^(/.*/[^\ ]*)\ ([^\ ]*\ .*)$ $1_$2 [N,DPI]
	RewriteRule ^(/.*/[^\ ]*)\ ([^\ ]*)$ $1_$2 [L,R=307]

	RewriteCond %{REQUEST_METHOD} TRACE
	RewriteRule .* - [F,L]
	RewriteRule ^(.*)/mw-config/(.*)$ %(BASE_URL) [NC,R=301,L]
	RewriteRule robots.txt /w/robots.txt [L]

	# "Regular" BlueSpice Farm rewrite rules
	RewriteRule ^/wiki/(.*?).php/(.+)$ /w/$1.php?sfr=w&title=$2 [QSA,L]
	RewriteRule ^/wiki/(.*?).php$ /w/{R:1}.php?sfr=w [QSA,L]
	RewriteRule ^/wiki/(.+)$ /w/index.php?title=$1&sfr=w [QSA,L]
	RewriteRule ^/wiki/([^/]+)/?$ /w/index.php?title=$1&sfr=w [QSA,L]
	RewriteRule ^w/(.*?)$ /w/$1?sfr=w [QSA,L]
	RewriteRule ^/([^/]*)/(.*?).php/(.+)$ /w/$2.php?sfr=$1&title=$3 [QSA,L]
	RewriteRule ^/([^/]*)/(.*?).php /w/$2.php?sfr=$1 [QSA,L]
	RewriteRule ^/([^/]*)/wiki/(.+)$ /w/index.php?title=$2&sfr=$1 [QSA,L]
	RewriteRule ^/([^/]*)/(.+)$ /w/$2 [QSA,L]
	RewriteRule ^/([^/]+)/?$ /w/index.php?sfr=$1 [QSA,L]
	RewriteRule ^/*$ /w/index.php [L]

	# Restrict access to all codebase
	<Directory /opt/bluespice>
		Options FollowSymLinks MultiViews
		AllowOverride None
		Require all denied
	</Directory>

	# MediaWiki core entrypoints
	<Files "w/api.php w/img_auth.php w/index.php w/load.php w/opensearch_desc.php w/rest.php w/thumb.php w/thumb_handler.php">
		Require all granted
	</Files>

	# BlueSpice entrypoints
	<Files "w/dynamic_file.php w/BLUESPICE-EDITION w/BLUESPICE-VERSION w/BUILDINFO">
		Require all granted
	</Files>

	ServerSignature off
	Header unset X-Powered-By

	ErrorLog /proc/self/fd/1
	CustomLog /proc/self/fd/1 combined
</VirtualHost>
