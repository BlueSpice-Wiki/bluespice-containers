#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

echo ""
echo "#############################################"
echo "Init data directory"

directories=(
  /data/bluespice/extensions/BlueSpiceFoundation/data
  /data/bluespice/images
  /data/bluespice/logs/postupdate
  /data/bluespice/logs
  /data/simplesamlphp/cache
  /data/simplesamlphp/certs
  /data/simplesamlphp/data
  /data/simplesamlphp/logs
)

appDir=/app/bluespice/w
runForAllScript=$appDir/extensions/BlueSpiceWikiFarm/SimpleFarmer/maintenance/RunForAll.php
bluespiceDataDir=/data/bluespice

if [ -f $runForAllScript ]; then
	directories=(
  /data/bluespice/extensions/BlueSpiceFoundation/data
  /data/bluespice/images
  /data/bluespice/_sf_instance
  /data/bluespice/_sf_archive
  /data/bluespice/logs/postupdate
  /data/bluespice/logs
  /data/simplesamlphp/cache
  /data/simplesamlphp/certs
  /data/simplesamlphp/data
  /data/simplesamlphp/logs
  )
fi

BSDATALIST="/tmp/bs_datalist.dat"
/usr/bin/find $bluespiceDataDir -maxdepth 1 -printf "%f\n"  > $BSDATALIST

while IFS= read -r element
do 
  if [ "${element}" == "extension" ]; then
		ln -fs ${bluespiceDataDir}/${element}/BlueSpiceFoundation/data ${appDir}/${element}/BlueSpiceFoundation/data
    continue
	fi
	if [ "${appDir}/${element}" ]; then
		rm -fr ${appDir}/${element}
    ln -fs ${bluespiceDataDir}/${element} ${appDir}/${element}
	fi

done < "${BSDATALIST}" &
rm -fr ${BSDATALIST}



declare -A files
files[/data/bluespice/pre-init-settings.php]="<?php"
files[/data/bluespice/post-init-settings.php]="<?php"
files[/data/bluespice/logs/postupdate/README.md]="Do not delete files from this directory!"

for file in "${!files[@]}"; do
  if [ ! -f "$file" ]; then
    echo -e "${files[$file]}" > "$file"
  fi
done

chown -R www-data:www-data /data
