#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

timestamp=$(date +%Y%m%d%H%M%S)
appDir=/app/bluespice/w

runForAllScript=$appDir/extensions/BlueSpiceWikiFarm/SimpleFarmer/maintenance/RunForAll.php

baseVersion=""
if [ -f /data/logs/baseversion ]; then
	baseVersion=$(cat /data/logs/baseversion)
fi
version=$(cat $appDir/BLUESPICE-VERSION)
edition=$(cat $appDir/BLUESPICE-EDITION)

if [ "$baseVersion" == "$version" ]; then
	echo "No version change, skipping updates"
	exit 0
fi

echo "Running updates"
echo "Version: $version"

if [ "${edtion}" = "farm" ]; then
	sed -i 's/.BlueSpice.php/Append.php/'
	php $appDir/maintenance/update.php --conf /app/conf/LocalSettings.php --quick | tee -a /data/logs/update-$timestamp.log
	php $runForAllScript --script='maintenance/update.php' --args='--quick' | tee -a /data/logs/update-$timestamp.log
fi

php $appDir/maintenance/update.php --conf /app/conf/LocalSettings.php --quick | tee -a /data/logs/update-$timestamp.log

echo $version > /data/logs/baseversion
