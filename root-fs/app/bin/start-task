#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

check-database
if [ $? -ne 0 ]; then
	date > /data/maintenance
	run-installation
	if [ $? -ne 0 ]; then
		echo "Installation failed"
		exit 1
	fi
	rm /data/maintenance
else
	date > /data/maintenance
	run-updates
	rm /data/maintenance
fi

echo ""
echo "#############################################"
echo "Starting TaskRunner"

appDir=/app/bluespice/w
processRunnerScript=$appDir/vendor/mwstake/mediawiki-component-processmanager/maintenance/processRunner.php
runjobs_pid=/tmp/bluespice_runjobs.pid
processrunner_pid=/tmp/process_runner.pid

kill_runner() {
	kill $runjobs_pid 2> /dev/null
	kill $processrunner_pid 2> /dev/null
}
##add Variables to Scripts
substitutePlaceholders /app/bin/config/backub_conf.json

trap kill_runner SIGTERM


while true; do
	sleep 2
done
