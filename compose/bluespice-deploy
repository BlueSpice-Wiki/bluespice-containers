#!/bin/bash

source .env
EXTENDED_TOOLS=""


if [[ "${EDITION}" == "pro" || "${EDITION}" == "farm" ]]; then
	if [[ ! $(grep 'docker.bluespice.com' $HOME/.docker/config.json) ]]; then 
		echo "In order to access our ${EDITION}-Image please login to docker.bluespice.com"
		docker login docker.bluespice.com
		if [[ ! $(grep 'docker.bluespice.com' $HOME/.docker/config.json) ]]; then 
		echo -e "\n-------------\n"
		echo "Please contact support@hallowelt.com for your Credentials against docker.bluespice.com"
		echo -e "\n-------------\n"
		exit
		fi
	fi
	EXTENDED_TOOLS="${EXTENDED_TOOLS} -f docker-compose.collabpads-service.yml"
	WIKI_REPO=docker.bluespice.com/bluespice-${EDITION}/wiki:${VERSION}
else
	WIKI_REPO=bluespice/wiki:${VERSION}
fi
if [ "${LETSENCRYPT}" == "true" ]; then
	EXTENDED_TOOLS="${EXTENDED_TOOLS} -f docker-compose.proxy-letsencrypt.yml"
fi
if [ "${KERBEROS}" == "true" ]; then
	EXTENDED_TOOLS="${EXTENDED_TOOLS} -f docker-compose.kerberos-proxy.yml"
fi
##allow custom services repo for testing
if [ -n "${SERVICES_REPOSITORY_PATH}" ]; then
	BLUESPICE_SERVICE_REPOSITORY=${SERVICES_REPOSITORY_PATH}
else
	BLUESPICE_SERVICE_REPOSITORY='bluespice'
fi
##allow custom wiki image for testing
if [ -n "${BLUESPICE_WIKI_IMAGE}" ]; then
	WIKI_REPO=${BLUESPICE_WIKI_IMAGE}
fi

	BLUESPICE_WIKI_REPOSITORY=${WIKI_REPO}	\
	BLUESPICE_SERVICE_REPOSITORY=${BLUESPICE_SERVICE_REPOSITORY} \
		docker compose \
		-f docker-compose.helper-service.yml \
		-f docker-compose.main.yml \
		-f docker-compose.persistent-data-services.yml \
		-f docker-compose.stateless-services.yml \
		-f docker-compose.proxy.yml \
		${EXTENDED_TOOLS} \
		$@
